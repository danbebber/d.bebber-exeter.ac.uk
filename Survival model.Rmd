---
title: "Accelerated failure time model for fungal spore germination"
author: "Dan Bebber"
date: "02/04/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Fungal spore germination

Fungi explore for food by growing networks of hyphae or by releasing spores. Spores enable long distance dispersal. Spores can be blown on the wind, splashed around by rain, float in rivers, or hitch a ride on animals, people, or vehicles. Under the right conditions, fungal spores germinate and then go on to colonize a food source or infect a host plant or animal. In the case of fungi that infect plant leaves (foliar pathogens), germination rate is largely determined by moisture and temperature. Sufficient moisture (either high humidity, or the presence of liquid water on the leaf surface) will allow germination, provided the temperature lies within certain bounds. Theoretically, then, if we know microclimatic conditions on a leaf surface, we can estimate rates of spore germination, infection and potentially the development of plant disease.

Here we develop a model that estimates spore germination and infection rates from microclimate data, via accelerated failure time Weibull survival models  dependent on temperature and moisture.

# Model
## Weibull survival model
Observations of populations of spores show that germination is a probabilistic survival process, meaning that under the right conditions spores will transition from one state (ungerminated) to another (germinated) with a certain probability of that happening within a certain time period. We can't know the exact time at which an individual spore will germinate, but trends and patterns over large populations can be described mathematically.

In *survival analysis*, the time $T$ to transition is a random variable in $(0,\infty)$ with probability density $f(t)$ and cumulative distribution $F(t)$ at time $t$ after initiation of the process. For large populations, $F(t)$ is equal to the mean fraction that have transitioned by $t$.
The probability of surviving in the untransformed state until $t$ is known as the *survival function*:
\begin{align}
S(t) = 1-F(t) = Pr(T>t)
\end{align}
The instantaneous risk of changing state at time $t$, given survival until $t$, is known as the *hazard function*:
\begin{align}
h(t) = \lim_{\Delta t \rightarrow 0} Pr(t \leq T < t+{\Delta t}|T\geq t)/{\Delta t}
\end{align}
The cumulative hazard $H(t)=\int_{0}^{t} h(s) ds$ is related to survival by $S(t) = e^{-H(t)}$.
We can therefore calculate the expected fraction of potential transitions that have occurred by $t$ from the area under the hazard function $h(t)$:
\begin{align}
F(t) = 1-S(t) = 1-e^{-H(t)}
\end{align}
If the hazard is constant over time ($h(t) = \lambda$), $H(t) = \lambda t$ and survival is described by the exponential distribution ($S(t) = e^{-\lambda t}$). In many real-world processes, however, $h(t)$ varies with $t$. The *Weibull distribution* is commonly used to model such processes. The Weibull distribution is defined by two parameters, the 'scale' $\alpha$ and the 'shape' $\gamma$:
\begin{align}
h(t) = \alpha \beta (\alpha t)^{\beta-1}
\end{align}
\begin{align}
H(t) = (\alpha t)^{\beta}
\end{align}
So, once we estimate $\alpha$ and $\beta$, the fraction of spores that have germinated by $t$ is:
\begin{align}
F(t) = 1-\exp[-(\alpha t)^{\beta}]
\end{align}
We can visualize how $\alpha$ and $\beta$ influence $F(t)$:

```{r fig1, echo = FALSE, fig.height=2, fig.width=6}
library(ggplot2)
theme_set(theme_classic())
dat <- expand.grid(alpha = c(0.2,1,2), beta = c(0.2, 0.5,1,2, 5), t = seq(0,6,by = 0.1))
dat$Ft <- 1 - exp(-(dat$alpha*dat$t)^dat$beta)
ggplot(dat, aes(x = t, y = Ft, group = beta, col = factor(beta))) + 
  geom_line() + facet_grid(cols = vars(alpha), labeller=label_both) +
  ylab("F(t)") + labs(colour = "beta")
```

Increasing $\alpha$ increases the rate of transition, $\beta > 1$ changes the shape of the curve to sigmoid.

## Accelerated failure time model

In survival analysis, an accelerated failure time model is one in which time is stretched or compressed by an acceleration factor $\gamma$, so that $F(\gamma t) = 1 - exp(-(\alpha \gamma t)^\beta)$.

The rate of fungal spore germination and infection varies not only over time, but also with temperature. We therefore model $\gamma$ as a function of temperature $\tau$. A beta function (Yan & Hunt 1999) provides a flexible means to vary $\gamma$. At the optimum temperature $\gamma(\tau_{\mathrm{opt}})=1$, and $\gamma(\tau)$ declines to zero as $\tau$ increases towards the maximum temperature $\tau_{\max}$ or decreases towards the minimum temperature $\tau_{\min}$:
\begin{align}
\gamma(\tau)=\left(\frac{\tau_{\max}-\tau}{\tau_{\max}-\tau_{\mathrm{opt}}}\right)\left(\frac{\tau-\tau_{\min}}
{\tau_{\mathrm{opt}}-\tau_{\min}}\right)^\frac{\tau_{\mathrm{opt}}-\tau_{\min}}{\tau_{\max}-\tau_{\mathrm{opt}}}
\end{align}
when $\tau_{\min} < \tau < \tau_{\max}$ and $\gamma(\tau)=0$ otherwise. Together, $\tau_{\min}$, $\tau_{\mathrm{opt}}$ and $\tau_{\max}$ are known as the *cardinal temperatures*. We can visualize the function with $\tau_{\min}=10$, $\tau_{\mathrm{opt}}=25$ and $\tau_{\max}=30$:

```{r fig2, echo = FALSE, fig.height=2, fig.width=3}
rtheta <- function(theta, tmin, topt, tmax){ 
  r <- ((tmax-theta)/(tmax-topt))*((theta-tmin)/(topt-tmin))^
    ((topt-tmin)/(tmax-topt))
  r[theta <= tmin | theta >= tmax] <- 0 #set values outside temperature range to zero
  r}

dat <- data.frame(temp = seq(0,40,by = 0.1), rate = rtheta(seq(0,40,by =0.1), 10,25,30))
ggplot(dat, aes(temp, rate)) + geom_line() + xlab("temperature (C)") + ylab(expression(gamma))
```

We model germination in discrete time steps. Hourly steps are convenient because meteorological data are seldom available at finer temporal resolution.

For many foliar fungal pathogens, both germination and infection require liquid water on the leaf surface. Germination only starts when leaves become wet, and ceases when leaves dry out again. Let integer $W$ be the leaf wetness duration in hours. Let **s** be a vector of temperature measurements taken at hourly intervals $(0,\ldots,W)$. Let $\mathbf{g}=\gamma(\mathbf{s})$ be a vector of acceleration factors $(g_0, \ldots, g_W)$. For simplicity we assume that the acceleration factor during the $i$th hour $\gamma_i=(g_i+g_{i-1})/2$ for $i=(1,\ldots,W)$. The effective elapsed time by the $i$th hour of a wet period is then the cumulative sum of $\gamma$:
\begin{align}
u_i = \sum_{k=1}^{i}\gamma_k d_k
\end{align}
where $d_k$ is the duration in hours of the $k$th time step. Because $d=1$ we can ignore it.
The fraction germinated by the end of the $i$th hour is then:
\begin{align}
F(i)=1-\exp(-\alpha(u_i)^\beta).
\end{align}

Next we assume that fresh cohorts of spores land on leaves in each hour of a wet period but that ungerminated spores do not accumulate from hour to hour, giving $j = 1,\ldots,W$ cohorts. The effective time elapsed for the $j$th cohort is:
\begin{align}
u_{i,j}= \sum_{k=j}^{i}\gamma_k
\end{align}
where $u=0$ for $j < i$.

We can estimate a relative germination score in each hour by summing $F(i)$ over all cohorts:
\begin{align}
F_{G}(i) = \sum_{j=1}^{W} F(i, j)
\end{align}

## Incorporating infection

For some pathogens, like *Hemileia vastatrix* that causes Coffee Leaf Rust, germination (denoted by subscript $G$) and appressorium formation (the pre-cursor to infection, denoted by subscript $A$) respond differently to temperature and must be modelled in separate stages. The accelerated failure time approach is applied to cohorts of spores forming appressoria, but the total relative number of appressoria formed is scaled to the number of spores germinated by the previous time-step: 
\begin{align}
F_{A}(i) = \sum_{j=1}^{W} F_{A}(i, j) F_{G}(i-1)
\end{align}
Thus, no spores form appressoria at $t=1$ because none have yet germinated (i.e. $F_{G}(0) = 0$).

# Numerical example
In the following example we use parameters taken from Bebber et al. (2016), except that the time is multiplied by $\alpha$ not divided.

```{r}
# Parameters for germination
par.G <- c(12.9, 21.4, 30.9, 1/13.4, 1.29)
# Parameters for appressorium formation
par.A <- c(11.6, 11.6, 32.1, 1/19.1, 2.14)
names(par.G) <- names(par.A) <- c("tmin", "topt", "tmax", "alpha", "beta")

# Temperature-dependent acceleration factor
gtau <- function(tau, card){ # card = vector of cardinal temperatures
g <- ((card[3]-tau)/(card[3]-card[2]))*((tau-card[1])/(card[2]-card[1]))^((card[2]-card[1])/(card[3]-card[2]))
g[tau <= card[1] | tau >= card[3]] <- 0 #set values outside temperature range to zero
g}

# Cumulative distribution function
Ft <- function(x, pars){ # pars = c(alpha, beta), x = (effective) time
  1 - exp(-(x*pars[1])^pars[2])
}

# Example for a single wet period of length W hours
s <- c(13,15,18,19,16,14) # Hourly temperatures from t = 0 to t = W
W <- length(s) - 1 # Length of wet period
gG <- gtau(s, card = par.G[1:3]) # Acceleration factor at each hour
gGi <- gG[1:(W)] + diff(gG)/2 # Mean acc. fac. in each hourly interval
uG <- cumsum(gGi) # Effective elapsed time
FG1 <- Ft(uG, par.G[4:5]) # Ft for first cohort
s
gG
gGi
uG
FG1
```
We can compare $F_{G}(t)$ for this cohort with that expected at optimal temperature ($\gamma = 1$):

```{r fig3, echo = FALSE, fig.height=2, fig.width=3}
Fe <- Ft(1:W,par.G[4:5])
dat <- data.frame(germ = c(FG1, Fe), Model = rep(c("Observed", "Expected"), each = W), t = 1:W)
ggplot(dat, aes(x = t, y = germ, group = Model, col = Model)) + geom_line() + ylab("F(t)")
```

We now include germination of all $j$ cohorts, that begin germinating at $t = 0,\ldots, W-1$. Thus, there are $W$ cohorts per wet period.
```{r}
gGm <- matrix(gGi, nr = W, nc = W); gGm # Repeat gi for each cohort
gGm[upper.tri(gGm)] <- 0; gGm # Set to zero for non-valid periods
uGm <- apply(gGm, 2, cumsum); uGm # Effective elapsed time
FGm <- apply(uGm, 2, Ft, pars = par.G[4:5]); FGm # F(t) per cohort
FG <- rowSums(FGm); FG # F(t) sum over all cohorts
```

We can plot the contribution of each cohort to the total germinated by time $t$:

```{r fig4, echo = FALSE, fig.height=2, fig.width=3 }
dat <- data.frame(FGt = as.vector(FGm), t = 1:W, cohort = factor(rep(1:W, each = W)))
ggplot(dat, aes(x = t, y = FGt, fill = cohort)) + geom_area(position = "stack", stat = "identity")
```

We now calculate the fraction of germinated spores that form appressoria.

```{r}
gA <- gtau(s, card = par.A[1:3]) # Acceleration factor at each hour
gAi <- gA[1:(W)] + diff(gA)/2 # Mean acc. fac. in each hourly interval
uA <- cumsum(gAi) # Effective elapsed time
gAm <- matrix(gAi, nr = W, nc = W); gAm # Repeat gi for each cohort
gAm[upper.tri(gAm)] <- 0; gAm # Set to zero for non-valid periods
uAm <- apply(gAm, 2, cumsum); uAm # Effective elapsed time
FAm <- apply(uAm, 2, Ft, pars = par.A[4:5]); FAm # F(t) per cohort
FGx <- matrix(c(0,FG[-W]), nr = W, nc = W, byrow= TRUE); FGx # Germinated cohorts (j-1)
FAs <- FAm * FGx; FAs # Scale appressorium formation by size of germinated cohorts
FA <- rowSums(FAm); FA # F(t) sum over all cohorts
```

Thus, at the end of this five hour wet period, only a small fraction of the available spores have germinated and formed appressoria.

```{r fig5, echo = FALSE, fig.height=2, fig.width=3 }
dat <- data.frame(FAt = as.vector(FAm), t = 1:W, cohort = factor(rep(1:W, each = W)))
ggplot(dat, aes(x = t, y = FAt, fill = cohort)) + geom_area(position = "stack", stat = "identity")
```

## Empirical example

tbc

